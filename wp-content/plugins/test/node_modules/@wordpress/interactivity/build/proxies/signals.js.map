{"version":3,"names":["_signals","require","_registry","_scopes","_namespaces","_utils","NO_SCOPE","PropSignal","constructor","owner","computedsByScope","WeakMap","setValue","value","update","setGetter","getter","get","getComputed","scope","getScope","valueSignal","getterSignal","has","callback","call","setNamespace","getNamespaceFromProxy","set","computed","withScope","resetNamespace","signal","peek","batch","exports"],"sources":["@wordpress/interactivity/src/proxies/signals.ts"],"sourcesContent":["/**\n * External dependencies\n */\nimport {\n\tcomputed,\n\tsignal,\n\tbatch,\n\ttype Signal,\n\ttype ReadonlySignal,\n} from '@preact/signals';\n\n/**\n * Internal dependencies\n */\nimport { getNamespaceFromProxy } from './registry';\nimport { getScope } from '../scopes';\nimport { setNamespace, resetNamespace } from '../namespaces';\nimport { withScope } from '../utils';\n\n/**\n * Identifier for property computeds not associated to any scope.\n */\nconst NO_SCOPE = {};\n\n/**\n * Structure that manages reactivity for a property in a state object. It uses\n * signals to keep track of property value or getter modifications.\n */\nexport class PropSignal {\n\t/**\n\t * Proxy that holds the property this PropSignal is associated with.\n\t */\n\tprivate owner: object;\n\n\t/**\n\t * Relation of computeds by scope. These computeds are read-only signals\n\t * that depend on whether the property is a value or a getter and,\n\t * therefore, can return different values depending on the scope in which\n\t * the getter is accessed.\n\t */\n\tprivate computedsByScope: WeakMap< WeakKey, ReadonlySignal >;\n\n\t/**\n\t * Signal with the value assigned to the related property.\n\t */\n\tprivate valueSignal?: Signal;\n\n\t/**\n\t * Signal with the getter assigned to the related property.\n\t */\n\tprivate getterSignal?: Signal< ( () => any ) | undefined >;\n\n\t/**\n\t * Structure that manages reactivity for a property in a state object, using\n\t * signals to keep track of property value or getter modifications.\n\t *\n\t * @param owner Proxy that holds the property this instance is associated\n\t *              with.\n\t */\n\tconstructor( owner: object ) {\n\t\tthis.owner = owner;\n\t\tthis.computedsByScope = new WeakMap();\n\t}\n\n\t/**\n\t * Changes the internal value. If a getter was set before, it is set to\n\t * `undefined`.\n\t *\n\t * @param value New value.\n\t */\n\tpublic setValue( value: unknown ) {\n\t\tthis.update( { value } );\n\t}\n\n\t/**\n\t * Changes the internal getter. If a value was set before, it is set to\n\t * `undefined`.\n\t *\n\t * @param getter New getter.\n\t */\n\tpublic setGetter( getter: () => any ) {\n\t\tthis.update( { get: getter } );\n\t}\n\n\t/**\n\t * Returns the computed that holds the result of evaluating the prop in the\n\t * current scope.\n\t *\n\t * These computeds are read-only signals that depend on whether the property\n\t * is a value or a getter and, therefore, can return different values\n\t * depending on the scope in which the getter is accessed.\n\t *\n\t * @return Computed that depends on the scope.\n\t */\n\tpublic getComputed(): ReadonlySignal {\n\t\tconst scope = getScope() || NO_SCOPE;\n\n\t\tif ( ! this.valueSignal && ! this.getterSignal ) {\n\t\t\tthis.update( {} );\n\t\t}\n\n\t\tif ( ! this.computedsByScope.has( scope ) ) {\n\t\t\tconst callback = () => {\n\t\t\t\tconst getter = this.getterSignal?.value;\n\t\t\t\treturn getter\n\t\t\t\t\t? getter.call( this.owner )\n\t\t\t\t\t: this.valueSignal?.value;\n\t\t\t};\n\n\t\t\tsetNamespace( getNamespaceFromProxy( this.owner ) );\n\t\t\tthis.computedsByScope.set(\n\t\t\t\tscope,\n\t\t\t\tcomputed( withScope( callback ) )\n\t\t\t);\n\t\t\tresetNamespace();\n\t\t}\n\n\t\treturn this.computedsByScope.get( scope )!;\n\t}\n\n\t/**\n\t *  Update the internal signals for the value and the getter of the\n\t *  corresponding prop.\n\t *\n\t * @param param0\n\t * @param param0.get   New getter.\n\t * @param param0.value New value.\n\t */\n\tprivate update( { get, value }: { get?: () => any; value?: unknown } ) {\n\t\tif ( ! this.valueSignal ) {\n\t\t\tthis.valueSignal = signal( value );\n\t\t\tthis.getterSignal = signal( get );\n\t\t} else if (\n\t\t\tvalue !== this.valueSignal.peek() ||\n\t\t\tget !== this.getterSignal!.peek()\n\t\t) {\n\t\t\tbatch( () => {\n\t\t\t\tthis.valueSignal!.value = value;\n\t\t\t\tthis.getterSignal!.value = get;\n\t\t\t} );\n\t\t}\n\t}\n}\n"],"mappings":"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","ignoreList":[]}